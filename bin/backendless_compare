#!/usr/bin/env node
const BackendlessConsole = require('../libs/backendless-console-api.js');
const chalk = require('chalk');
const checkForArguments = require('../utils/checkArgs');
const commandLineArgs = require('command-line-args');
const getUsage = require('command-line-usage');

const ansi_banner = require('../constants/command-banner');
const optionDefinitions = require('../constants/command-options');
const util = require('util');
const banner = getUsage(ansi_banner);
const options = commandLineArgs(optionDefinitions);
const { AppRolesCompare } = require('../libs/comparator');
const compareTables = require('../libs/comparator/compare-tables')

let backendless, beAppState;


checkForArguments(options.compare)
    .then(() => {
        const {
            'username': username,
            'password': password,
            'application-control': appControl,
            'applications-to-check': appsToCheck,
            'dump-application-control': dumpPath,
            'reporting-directory': reportingDir,
            'backendless-url': beURL,
            'timeout': timeout,
            'verbose': verboseOutput,
            'monitor': monitorMode
        } = options.compare;

        !monitorMode && console.log(banner)

        backendless = new BackendlessConsole(username, password, beURL, appControl, appsToCheck, reportingDir,timeout, verboseOutput);

        return backendless.getAppMeta()
            .then(() => backendless.getAppDataTables())
            .then(() => backendless.getAppRoles())
            .then(() => backendless.getAppRolePermissions())
//            .then(() => backendless.getAppDataTableUserPermissions())
            .then(() => backendless.getAppDataTableRolePermissions())
            .then(() => backendless.updateAppRefs())
            .then(appData => beAppState = appData)
            .then(() => [beAppState.controlApp, ...beAppState.appsToCheck].forEach(BackendlessConsole.normalize))
            .then(() => dumpPath && BackendlessConsole.saveDataToFile(beAppState.controlApp, dumpPath, verboseOutput))
            .then(() => compareTables([beAppState.controlApp, ...beAppState.appsToCheck], {monitorMode}))
            .then(() => {
                new AppRolesCompare(beAppState.controlApp, beAppState.appsToCheck).compareData();
            })
    })

    .catch((err) => {
        console.log(util.inspect(err));
        console.log(chalk.bold.red(err));

        process.exit(1)
    });


function getHtmlTemplate(insertDiff) {
    return '<!DOCTYPE html><html><head><script type="text/javascript" src="build/jsondiffpatch.min.js"></script><script type="text/javascript" src="build/jsondiffpatch-formatters.min.js"></script><link rel="stylesheet" href="html.css" type="text/css" /></head>' +
    '<body><hr/><div id="visual"></div><hr/><script>document.getElementById(\'visual\').innerHTML = ' + JSON.stringify(insertDiff) +
    ';</script></body></html>';
}
